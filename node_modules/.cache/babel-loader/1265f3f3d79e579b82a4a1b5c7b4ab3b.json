{"ast":null,"code":"import _asyncToGenerator from \"/Users/dimartinez/workspace/metrics-api-fe/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"/Users/dimartinez/workspace/metrics-api-fe/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _objectSpread from \"/Users/dimartinez/workspace/metrics-api-fe/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\n\nvar _jsxFileName = \"/Users/dimartinez/workspace/metrics-api-fe/src/app/contexts/JWTAuthContext.js\",\n    _this = this,\n    _s = $RefreshSig$();\n\nimport _regeneratorRuntime from \"/Users/dimartinez/workspace/metrics-api-fe/node_modules/@babel/runtime/regenerator/index.js\";\nimport React, { createContext, useEffect, useReducer } from 'react';\nimport jwtDecode from 'jwt-decode';\nimport axios from 'axios.js';\nimport { MatxLoading } from 'app/components';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar initialState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null\n};\n\nvar isValidToken = function isValidToken(accessToken) {\n  if (!accessToken) {\n    return false;\n  }\n\n  var decodedToken = jwtDecode(accessToken);\n  var currentTime = Date.now() / 1000;\n  return decodedToken.exp > currentTime;\n};\n\nvar setSession = function setSession(accessToken) {\n  if (accessToken) {\n    localStorage.setItem('accessToken', accessToken);\n    axios.defaults.headers.common.Authorization = \"Bearer \".concat(accessToken);\n  } else {\n    localStorage.removeItem('accessToken');\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\n\nvar reducer = function reducer(state, action) {\n  switch (action.type) {\n    case 'INIT':\n      {\n        var _action$payload = action.payload,\n            isAuthenticated = _action$payload.isAuthenticated,\n            user = _action$payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: isAuthenticated,\n          isInitialised: true,\n          user: user\n        });\n      }\n\n    case 'LOGIN':\n      {\n        var _user = action.payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: true,\n          user: _user\n        });\n      }\n\n    case 'LOGOUT':\n      {\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: false,\n          user: null\n        });\n      }\n\n    case 'REGISTER':\n      {\n        var _user2 = action.payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: true,\n          user: _user2\n        });\n      }\n\n    default:\n      {\n        return _objectSpread({}, state);\n      }\n  }\n};\n\nvar AuthContext = /*#__PURE__*/createContext(_objectSpread(_objectSpread({}, initialState), {}, {\n  method: 'JWT',\n  login: function login() {\n    return Promise.resolve();\n  },\n  logout: function logout() {},\n  register: function register() {\n    return Promise.resolve();\n  }\n}));\nexport var AuthProvider = function AuthProvider(_ref) {\n  _s();\n\n  var children = _ref.children;\n\n  var _useReducer = useReducer(reducer, initialState),\n      _useReducer2 = _slicedToArray(_useReducer, 2),\n      state = _useReducer2[0],\n      dispatch = _useReducer2[1];\n\n  var login = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(email, password) {\n      var response, _response$data, accessToken, user;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return axios.post('/api/auth/login', {\n                email: email,\n                password: password\n              });\n\n            case 2:\n              response = _context.sent;\n              _response$data = response.data, accessToken = _response$data.accessToken, user = _response$data.user;\n              setSession(accessToken);\n              dispatch({\n                type: 'LOGIN',\n                payload: {\n                  user: user\n                }\n              });\n\n            case 6:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function login(_x, _x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var register = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(email, username, password) {\n      var response, _response$data2, accessToken, user;\n\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return axios.post('/api/auth/register', {\n                email: email,\n                username: username,\n                password: password\n              });\n\n            case 2:\n              response = _context2.sent;\n              _response$data2 = response.data, accessToken = _response$data2.accessToken, user = _response$data2.user;\n              setSession(accessToken);\n              dispatch({\n                type: 'REGISTER',\n                payload: {\n                  user: user\n                }\n              });\n\n            case 6:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function register(_x3, _x4, _x5) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var logout = function logout() {\n    setSession(null);\n    dispatch({\n      type: 'LOGOUT'\n    });\n  };\n\n  useEffect(function () {\n    ;\n\n    _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var accessToken, response, user;\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.prev = 0;\n              accessToken = window.localStorage.getItem('accessToken');\n\n              if (!(accessToken && isValidToken(accessToken))) {\n                _context3.next = 11;\n                break;\n              }\n\n              setSession(accessToken);\n              _context3.next = 6;\n              return axios.get('/api/auth/profile');\n\n            case 6:\n              response = _context3.sent;\n              user = response.data.user;\n              dispatch({\n                type: 'INIT',\n                payload: {\n                  isAuthenticated: true,\n                  user: user\n                }\n              });\n              _context3.next = 12;\n              break;\n\n            case 11:\n              dispatch({\n                type: 'INIT',\n                payload: {\n                  isAuthenticated: false,\n                  user: null\n                }\n              });\n\n            case 12:\n              _context3.next = 18;\n              break;\n\n            case 14:\n              _context3.prev = 14;\n              _context3.t0 = _context3[\"catch\"](0);\n              console.error(_context3.t0);\n              dispatch({\n                type: 'INIT',\n                payload: {\n                  isAuthenticated: false,\n                  user: null\n                }\n              });\n\n            case 18:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[0, 14]]);\n    }))();\n  }, []);\n\n  if (!state.isInitialised) {\n    return /*#__PURE__*/_jsxDEV(MatxLoading, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 16\n    }, _this);\n  }\n\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: _objectSpread(_objectSpread({}, state), {}, {\n      method: 'JWT',\n      login: login,\n      logout: logout,\n      register: register\n    }),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 171,\n    columnNumber: 9\n  }, _this);\n};\n\n_s(AuthProvider, \"bgCdjuTOmPdSBRwTap80EFd9Y3U=\");\n\n_c = AuthProvider;\nexport default AuthContext;\n\nvar _c;\n\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"sources":["/Users/dimartinez/workspace/metrics-api-fe/src/app/contexts/JWTAuthContext.js"],"names":["React","createContext","useEffect","useReducer","jwtDecode","axios","MatxLoading","initialState","isAuthenticated","isInitialised","user","isValidToken","accessToken","decodedToken","currentTime","Date","now","exp","setSession","localStorage","setItem","defaults","headers","common","Authorization","removeItem","reducer","state","action","type","payload","AuthContext","method","login","Promise","resolve","logout","register","AuthProvider","children","dispatch","email","password","post","response","data","username","window","getItem","get","console","error"],"mappings":"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","sourcesContent":["import React, { createContext, useEffect, useReducer } from 'react'\nimport jwtDecode from 'jwt-decode'\nimport axios from 'axios.js'\nimport { MatxLoading } from 'app/components'\n\nconst initialState = {\n    isAuthenticated: false,\n    isInitialised: false,\n    user: null,\n}\n\nconst isValidToken = (accessToken) => {\n    if (!accessToken) {\n        return false\n    }\n\n    const decodedToken = jwtDecode(accessToken)\n    const currentTime = Date.now() / 1000\n    return decodedToken.exp > currentTime\n}\n\nconst setSession = (accessToken) => {\n    if (accessToken) {\n        localStorage.setItem('accessToken', accessToken)\n        axios.defaults.headers.common.Authorization = `Bearer ${accessToken}`\n    } else {\n        localStorage.removeItem('accessToken')\n        delete axios.defaults.headers.common.Authorization\n    }\n}\n\nconst reducer = (state, action) => {\n    switch (action.type) {\n        case 'INIT': {\n            const { isAuthenticated, user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated,\n                isInitialised: true,\n                user,\n            }\n        }\n        case 'LOGIN': {\n            const { user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated: true,\n                user,\n            }\n        }\n        case 'LOGOUT': {\n            return {\n                ...state,\n                isAuthenticated: false,\n                user: null,\n            }\n        }\n        case 'REGISTER': {\n            const { user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated: true,\n                user,\n            }\n        }\n        default: {\n            return { ...state }\n        }\n    }\n}\n\nconst AuthContext = createContext({\n    ...initialState,\n    method: 'JWT',\n    login: () => Promise.resolve(),\n    logout: () => { },\n    register: () => Promise.resolve(),\n})\n\nexport const AuthProvider = ({ children }) => {\n    const [state, dispatch] = useReducer(reducer, initialState)\n\n    const login = async (email, password) => {\n        const response = await axios.post('/api/auth/login', {\n            email,\n            password,\n        })\n        const { accessToken, user } = response.data\n\n        setSession(accessToken)\n\n        dispatch({\n            type: 'LOGIN',\n            payload: {\n                user,\n            },\n        })\n    }\n\n    const register = async (email, username, password) => {\n        const response = await axios.post('/api/auth/register', {\n            email,\n            username,\n            password,\n        })\n\n        const { accessToken, user } = response.data\n\n        setSession(accessToken)\n\n        dispatch({\n            type: 'REGISTER',\n            payload: {\n                user,\n            },\n        })\n    }\n\n    const logout = () => {\n        setSession(null)\n        dispatch({ type: 'LOGOUT' })\n    }\n\n    useEffect(() => {\n        ; (async () => {\n            try {\n                const accessToken = window.localStorage.getItem('accessToken')\n\n                if (accessToken && isValidToken(accessToken)) {\n                    setSession(accessToken)\n                    const response = await axios.get('/api/auth/profile')\n                    const { user } = response.data\n\n                    dispatch({\n                        type: 'INIT',\n                        payload: {\n                            isAuthenticated: true,\n                            user,\n                        },\n                    })\n                } else {\n                    dispatch({\n                        type: 'INIT',\n                        payload: {\n                            isAuthenticated: false,\n                            user: null,\n                        },\n                    })\n                }\n            } catch (err) {\n                console.error(err)\n                dispatch({\n                    type: 'INIT',\n                    payload: {\n                        isAuthenticated: false,\n                        user: null,\n                    },\n                })\n            }\n        })()\n    }, [])\n\n    if (!state.isInitialised) {\n        return <MatxLoading />\n    }\n\n    return (\n        <AuthContext.Provider\n            value={{\n                ...state,\n                method: 'JWT',\n                login,\n                logout,\n                register,\n            }}\n        >\n            {children}\n        </AuthContext.Provider>\n    )\n}\n\nexport default AuthContext\n"]},"metadata":{},"sourceType":"module"}